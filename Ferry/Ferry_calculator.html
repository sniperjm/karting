<!DOCTYPE html>
<html lang="nl">
<head>
  <meta charset="UTF-8" />
  <title>Sproeier Calculator</title>
  <style>
    body {
      font-family: "Segoe UI", Arial, sans-serif;
      max-width: 620px;
      margin: 20px auto;
      padding: 80px 20px 20px;
      border-radius: 16px;
      background: linear-gradient(135deg, #0a0d13 0%, #0f1824 100%);
      color: #f4f6fa;
      position: relative;
      box-shadow: 0 0 25px rgba(0,0,0,0.5);
    }

    .logo-wrapper {
      position: absolute;
      top: 20px;
      right: 20px;
    }
    .logo-wrapper img {
      width: 110px;
      height: auto;
      display: block;
    }

    h1 {
      font-size: 24px;
      margin-bottom: 8px;
      color: #ffffff;
      border-bottom: 2px solid #0066cc;
      display: inline-block;
      padding-bottom: 4px;
    }

    h2 {
      font-size: 18px;
      margin-top: 28px;
      margin-bottom: 6px;
      color: #ffffff;
      border-bottom: 1px solid #20314d;
      display: inline-block;
      padding-bottom: 3px;
    }

    p {
      color: #cbd4e2;
      font-size: 14px;
      line-height: 1.5;
    }

    label {
      display: block;
      margin-top: 12px;
      font-weight: bold;
      color: #99b8ff;
      font-size: 14px;
    }

    input, select {
      width: 100%;
      padding: 8px 10px;
      margin-top: 4px;
      box-sizing: border-box;
      border: 1px solid #243b63;
      border-radius: 8px;
      background: #141c2b;
      color: #ffffff;
      font-size: 15px;
    }
    input::placeholder { color: #667; }

    button {
      margin-top: 14px;
      padding: 12px 16px;
      border: none;
      border-radius: 12px;
      cursor: pointer;
      font-weight: bold;
      color: #fff;
      transition: all 0.25s ease;
    }
    button:hover { transform: scale(1.03); }

    #bereken { background: #0066cc; }
    #bereken:hover { background: #1b7ef5; }

    #gps { background: #d63031; }
    #gps:hover { background: #ff3b3b; }

    #reset {
      background: transparent;
      border: 1px solid #667;
      color: #bbb;
    }
    #reset:hover { background: #222; }

    .knoppen {
      display: flex;
      flex-direction: column;
      gap: 10px;
      margin-top: 18px;
    }

    #resultaat {
      margin-top: 24px;
      font-size: 20px;
      font-weight: bold;
      color: #fff;
    }

    .extra-info {
      margin-top: 6px;
      font-size: 14px;
      color: #b5c1d8;
    }

    #bougie {
      margin-top: 28px;
      padding: 14px;
      border-top: 1px solid #20314d;
      border-radius: 8px;
      display: flex;
      align-items: center;
      gap: 10px;
      transition: background 0.3s ease, color 0.3s ease;
    }

    .bougie-warm {
      background: rgba(220, 53, 69, 0.15);
      color: #ff6666;
      border-left: 3px solid #ff4444;
    }
    .bougie-normaal {
      background: rgba(0, 102, 204, 0.15);
      color: #66aaff;
      border-left: 3px solid #007bff;
    }
    .bougie-koud {
      background: rgba(33, 150, 243, 0.15);
      color: #5bc0ff;
      border-left: 3px solid #3399ff;
    }

    .bougie-icoon { font-size: 22px; }

    /* Luchtschroef-blok */
    #luchtschroef-resultaat {
      margin-top: 10px;
      font-size: 14px;
      color: #d1dcf5;
    }
    .tag {
      display: inline-block;
      padding: 2px 10px;
      border-radius: 999px;
      background: #141c2b;
      border: 1px solid #243b63;
      font-size: 12px;
      margin-bottom: 4px;
    }
    #luchtschroef-bereken {
      background: #009688;
    }
    #luchtschroef-bereken:hover {
      background: #11aa99;
    }
  </style>
</head>
<body>
  <div class="logo-wrapper">
    <img src="owendvh-logo.svg" alt="Owendvh logo" />
  </div>

  <h1>Sproeier Calculator</h1>
  <p>
    Vul de weergegevens in of gebruik GPS om deze automatisch op te halen.
    De berekening gebruikt het Prisma-model (baseline 133, 1.47 jet per 1% œÅ-verandering).
  </p>

  <label for="temp">Temperatuur (¬∞C)</label>
  <input id="temp" type="number" placeholder="¬∞C" />

  <label for="druk">Luchtdruk (hPa)</label>
  <input id="druk" type="number" placeholder="hPa" />

  <label for="vocht">Vochtigheid (%)</label>
  <input id="vocht" type="number" placeholder="%" />

  <label for="hoogte">Hoogte (m boven zeeniveau)</label>
  <input id="hoogte" type="number" placeholder="m" value="0" />

  <div class="knoppen">
    <button id="bereken" type="button">Bereken sproeier</button>
    <button id="gps" type="button">üå§ Haal weer op via GPS</button>
    <button id="reset" type="button">Reset alle velden</button>
  </div>

  <div id="resultaat"></div>
  <div id="density" class="extra-info"></div>
  <div id="extra" class="extra-info"></div>
  <div id="luchtschroef-auto" class="extra-info"></div>

  <div id="bougie" class="bougie-normaal">
    <span class="bougie-icoon">‚öñÔ∏è</span>
    <span id="bougie-text"><strong>Advies bougie:</strong> nog geen berekening uitgevoerd.</span>
  </div>

  <!-- Luchtschroef-blok -->
  <h2>Luchtschroef fine-tuning Rotax Max EVO</h2>
  <p class="extra-info">
    De tool berekent een <strong>theoretische luchtschroefstand</strong> op basis van luchtdichtheid.
    Gebruik die als basis en pas hem eventueel aan op basis van het gedrag van de motor.
  </p>

  <label for="basisLuchtschroef">Basis luchtschroef (slagen open)</label>
  <input
    id="basisLuchtschroef"
    type="number"
    step="0.01"
    placeholder="Wordt ingevuld na sproeier-berekening"
  />

  <label for="gedragMotor">Gedrag van de motor</label>
  <select id="gedragMotor">
    <option value="">Kies een situatie...</option>
    <option value="hoogstationair">Blijft hoog in toeren hangen bij gas los (te arm)</option>
    <option value="smoortgas">Smoort / verslikt zich bij gas oppakken (te rijk)</option>
    <option value="valtuit">Valt uit bij stationair (te arm stationair)</option>
    <option value="zachtloopt">Loopt mooi stabiel (goed)</option>
  </select>

  <button id="luchtschroef-bereken" type="button">Bereken luchtschroef advies</button>
  <div id="luchtschroef-resultaat"></div>

  <script>
    const R_DROOG = 287.058, R_WATER = 461.495, RHO_REF = 1.225;

    function verzadigingsdruk_hPa(tC) {
      return 6.112 * Math.exp((17.62 * tC) / (243.12 + tC));
    }

    function luchtdrukOpHoogte_hPa(p0, hoogteMeter, tempC) {
      const T = tempC + 273.15;
      const g = 9.80665, M = 0.0289644, R = 8.3144598;
      return p0 * Math.exp((-g * M * hoogteMeter) / (R * T));
    }

    function berekenDichtheid(tempC, druk_hPa, vochtPct, hoogteMeter) {
      const p_hPa = luchtdrukOpHoogte_hPa(druk_hPa, hoogteMeter, tempC);
      const T = tempC + 273.15;
      const e_hPa = verzadigingsdruk_hPa(tempC) * (vochtPct / 100);
      const e_Pa = e_hPa * 100;
      const P_Pa = p_hPa * 100;
      const pDroog = P_Pa - e_Pa;
      return (pDroog / (R_DROOG * T)) + (e_Pa / (R_WATER * T));
    }

    function deltaRhoPercent(rho) {
      return ((rho - RHO_REF) / RHO_REF) * 100;
    }

    function prismaJet(rho) {
      const delta = deltaRhoPercent(rho);
      const jet = 133 + delta * 1.47;
      return Math.round(Math.max(115, Math.min(155, jet)));
    }

    function updateBougie(rho) {
      const bougieDiv = document.getElementById('bougie');
      const bougieText = document.getElementById('bougie-text');
      const icon = bougieDiv.querySelector(".bougie-icoon");

      bougieDiv.className = "bougie-normaal";
      icon.textContent = "‚öñÔ∏è";
      bougieText.innerHTML = "<strong>Advies bougie:</strong> Denso IW27 ‚Äì normale omstandigheden.";

      if (rho > 1.220) {
        bougieDiv.className = "bougie-warm";
        icon.textContent = "üî•";
        bougieText.innerHTML = "<strong>Advies bougie:</strong> Denso IW24 ‚Äì koude/dichte lucht (meer warmte).";
      } else if (rho < 1.200) {
        bougieDiv.className = "bougie-koud";
        icon.textContent = "‚ùÑÔ∏è";
        bougieText.innerHTML = "<strong>Advies bougie:</strong> Denso IW29 ‚Äì warme/dunne lucht (koude bougie).";
      }
    }

    function berekenSproeier() {
      const temp = parseFloat(document.getElementById('temp').value);
      const druk = parseFloat(document.getElementById('druk').value);
      const vocht = parseFloat(document.getElementById('vocht').value);
      const hoogte = parseFloat(document.getElementById('hoogte').value);

      if (isNaN(temp) || isNaN(druk) || isNaN(vocht) || isNaN(hoogte)) {
        document.getElementById('resultaat').textContent = 'Vul alle velden goed in a.u.b.';
        document.getElementById('density').textContent = '';
        document.getElementById('extra').textContent = '';
        document.getElementById('luchtschroef-auto').textContent = '';
        updateBougie(1.215);
        return;
      }

      const rho = berekenDichtheid(temp, druk, vocht, hoogte);
      const jet = prismaJet(rho);
      const delta = deltaRhoPercent(rho);
      const deltaText = (delta >= 0 ? '+' : '') + delta.toFixed(1) + '% t.o.v. 1.225';

      document.getElementById('resultaat').textContent = 'Aanbevolen sproeier: ' + jet;
      document.getElementById('density').textContent =
        'Luchtdichtheid: ' + rho.toFixed(3) +
        ' kg/m¬≥ (' + deltaText + ')';
      document.getElementById('extra').textContent = 'Controleer altijd bougiekleur en prestaties.';

      // Theoretische luchtschroef op basis van luchtdichtheid
      // Basis = 2.00 slagen bij delta = 0%
      // Voor elke +1% dichtere lucht ‚Üí +0,05 slag
      // Voor elke -1% dunnere lucht ‚Üí -0,05 slag
      const basisAir = 2.0;
      let airScrewRaw = basisAir + 0.05 * delta;
      // Grenzen iets strakker: 1.75 tot 2.25
      let airScrew = Math.max(1.75, Math.min(2.25, airScrewRaw));

      // Weer-profiel + uitleg
      let profiel, uitleg;
      if (delta > 3) {
        profiel = "Koude/dichte lucht";
        uitleg = "De lucht is duidelijk dichter dan standaard, daarom een iets rijkere basisafstelling (meer slagen open t.o.v. 2.00).";
      } else if (delta < -3) {
        profiel = "Warme/dunne lucht";
        uitleg = "De lucht is duidelijk dunner dan standaard, daarom een iets armere basisafstelling (minder slagen open t.o.v. 2.00).";
      } else {
        profiel = "Gemiddelde omstandigheden";
        uitleg = "De luchtdichtheid ligt dicht bij standaard, alleen een kleine correctie rond 2.00 slagen is nodig.";
      }

      document.getElementById('luchtschroef-auto').innerHTML =
        `<span class="tag">${profiel}</span><br/>
         Theoretische luchtschroef: <strong>${airScrew.toFixed(2)} slagen open</strong><br/>
         <span class="extra-info">
           Referentie: 2.00 slagen open bij 1.225 kg/m¬≥.<br/>
           Huidige luchtdichtheid: ${rho.toFixed(3)} kg/m¬≥ (${deltaText})<br/>
           ${uitleg}
         </span>`;

      // Vul de basis-luchtschroef alleen in als dat veld nog leeg is
      const basisInput = document.getElementById('basisLuchtschroef');
      if (!basisInput.value) {
        basisInput.value = airScrew.toFixed(2);
      }

      updateBougie(rho);
    }

    async function haalWeerViaGPS() {
      const status = document.getElementById('resultaat');
      status.textContent = 'GPS zoeken...';

      if (!navigator.geolocation) {
        status.textContent = 'GPS niet beschikbaar op dit apparaat.';
        return;
      }

      navigator.geolocation.getCurrentPosition(async (pos) => {
        const { latitude, longitude } = pos.coords;
        status.textContent = 'Weer ophalen...';

        try {
          const url = `https://api.open-meteo.com/v1/forecast?latitude=${latitude}&longitude=${longitude}&current=temperature_2m,relative_humidity_2m,pressure_msl`;
          const res = await fetch(url);
          const data = await res.json();
          const cur = data.current;

          document.getElementById('temp').value = cur.temperature_2m.toFixed(1);
          document.getElementById('druk').value = cur.pressure_msl.toFixed(1);
          document.getElementById('vocht').value = cur.relative_humidity_2m.toFixed(0);
          document.getElementById('hoogte').value = 0;

          status.textContent = 'Weerdata geladen.';
          berekenSproeier();
        } catch {
          status.textContent = 'Kon weer niet ophalen (geen internet of API-fout).';
        }
      }, () => {
        status.textContent = 'GPS geweigerd of mislukt.';
      });
    }

    function resetVelden() {
      ['temp', 'druk', 'vocht', 'hoogte'].forEach(id => {
        document.getElementById(id).value = id === 'hoogte' ? '0' : '';
      });
      document.getElementById('resultaat').textContent = '';
      document.getElementById('density').textContent = '';
      document.getElementById('extra').textContent = '';
      document.getElementById('luchtschroef-auto').textContent = '';
      updateBougie(1.215);

      document.getElementById('basisLuchtschroef').value = '';
      document.getElementById('gedragMotor').value = '';
      document.getElementById('luchtschroef-resultaat').textContent = '';
    }

    function berekenLuchtschroefCorrectie() {
      const basis = parseFloat(document.getElementById('basisLuchtschroef').value);
      const gedrag = document.getElementById('gedragMotor').value;
      const resultDiv = document.getElementById('luchtschroef-resultaat');

      if (isNaN(basis) || !gedrag) {
        resultDiv.innerHTML = "<span class='extra-info'>Vul eerst de basisstand √©n het gedrag van de motor in.</span>";
        return;
      }

      let nieuw = basis;
      let advies = "";
      let label = "";

      switch (gedrag) {
        case "hoogstationair":
          nieuw = basis - 0.25;
          advies = "Motor is waarschijnlijk iets te arm bij gas dicht. Draai de luchtschroef iets dichter (‚Äì0,25 slag).";
          label = "Te arm / hoog stationair";
          break;
        case "smoortgas":
          nieuw = basis + 0.25;
          advies = "Motor is waarschijnlijk iets te rijk bij oppakken van het gas. Draai de luchtschroef iets verder open (+0,25 slag).";
          label = "Te rijk bij gas oppakken";
          break;
        case "valtuit":
          nieuw = basis - 0.25;
          advies = "Te arm rond stationair. Luchtschroef iets dichter (‚Äì0,25 slag) en eventueel stationair schroef iets indraaien.";
          label = "Te arm / valt uit";
          break;
        case "zachtloopt":
          nieuw = basis;
          advies = "Afstelling lijkt goed. Laat de luchtschroef op deze stand staan.";
          label = "Afstelling OK";
          break;
      }

      resultDiv.innerHTML = `
        <div class="tag">${label}</div><br/>
        <strong>${advies}</strong><br/><br/>
        <span class="extra-info">
          Nieuwe richtwaarde luchtschroef: <strong>${nieuw.toFixed(2)} slagen open</strong><br/>
          Oorspronkelijke basis: ${basis.toFixed(2)}<br/>
          Verander per keer maximaal ¬±0,25 slag en test een paar ronden.
        </span>
      `;
    }

    document.getElementById('bereken').addEventListener('click', berekenSproeier);
    document.getElementById('gps').addEventListener('click', haalWeerViaGPS);
    document.getElementById('reset').addEventListener('click', resetVelden);
    document.getElementById('luchtschroef-bereken').addEventListener('click', berekenLuchtschroefCorrectie);
  </script>
</body>
</html>
